# ğŸ¯ AI Extraction System - Visual Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER INTERFACE (React)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Dashboard                          Admin Panel                  â”‚
â”‚  â”œâ”€ Upload Invoice        â†’         â”œâ”€ Attention Queue         â”‚
â”‚  â”œâ”€ View Status            â†’         â”œâ”€ Review Invoices       â”‚
â”‚  â””â”€ See Approval           â†’         â”œâ”€ Approve/Reject        â”‚
â”‚                                      â””â”€ View Analytics         â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  File Upload    â”‚        â”‚   API Client    â”‚
    â”‚  (Supabase      â”‚        â”‚   (js fetch)    â”‚
    â”‚   Storage)      â”‚        â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â”‚        POST /api/ai/extract
              â”‚        + fileBase64 + invoiceId
              â”‚
              â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
â”‚        BACKEND API ROUTES (Next.js)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  POST /api/ai/extract                           â”‚
â”‚  â”œâ”€ Verify auth + ownership                    â”‚
â”‚  â”œâ”€ Get invoice from DB                        â”‚
â”‚  â”œâ”€ Call OpenRouter API                        â”‚
â”‚  â”œâ”€ Extract invoice data                       â”‚
â”‚  â”œâ”€ Calculate confidence score                 â”‚
â”‚  â”œâ”€ Determine auto-approval                    â”‚
â”‚  â”œâ”€ Update invoice in DB                       â”‚
â”‚  â”œâ”€ Store extraction confidence                â”‚
â”‚  â”œâ”€ Log activity                               â”‚
â”‚  â””â”€ Return results to client                   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ service role key
            â”‚ (secure server-side only)
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    OPENROUTER API (gpt-oss-20b)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                               â”‚
â”‚  Input: Base64 image                          â”‚
â”‚         Extraction prompt                     â”‚
â”‚                                               â”‚
â”‚  Processing:                                  â”‚
â”‚  1. Analyze invoice image                    â”‚
â”‚  2. Identify fields (invoice#, date, etc)   â”‚
â”‚  3. Extract text values                      â”‚
â”‚  4. Assess confidence per field              â”‚
â”‚  5. Return JSON response                     â”‚
â”‚                                               â”‚
â”‚  Output: Extracted data + confidence scores   â”‚
â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ JSON with extracted data
            â”‚ + field-level confidence
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CONFIDENCE SCORING (lib/ai/confidence.ts)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  Apply Weights:                               â”‚
â”‚  â€¢ GSTIN: 20% (critical)                      â”‚
â”‚  â€¢ Amount: 30% (key financial)                â”‚
â”‚  â€¢ Taxes: 25% (crucial)                       â”‚
â”‚  â€¢ HSN: 15% (classification)                  â”‚
â”‚  â€¢ Others: 10%                                â”‚
â”‚                                                â”‚
â”‚  Calculate Weighted Score:                    â”‚
â”‚  Overall = Î£(field_score Ã— weight)            â”‚
â”‚                                                â”‚
â”‚  Determine Status:                            â”‚
â”‚  â‰¥ 0.95 â†’ "auto_approve" âœ…                   â”‚
â”‚  0.80-0.95 â†’ "review" âš ï¸                      â”‚
â”‚  < 0.80 â†’ "reject" âŒ                         â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ status + confidence_score
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AUTO-APPROVAL LOGIC (lib/ai/approval.ts)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                               â”‚
â”‚  if status == "auto_approve" {               â”‚
â”‚    â”œâ”€ Update invoice.status = "approved"    â”‚
â”‚    â”œâ”€ Set approved_by = "ai_system"         â”‚
â”‚    â”œâ”€ Set approved_at = NOW()               â”‚
â”‚    â”œâ”€ Log activity                          â”‚
â”‚    â”œâ”€ Update GST summary                    â”‚
â”‚    â””â”€ Client sees "Approved" immediately   â”‚
â”‚  }                                           â”‚
â”‚                                               â”‚
â”‚  else if status == "review" {                â”‚
â”‚    â”œâ”€ Update invoice.status = "review"     â”‚
â”‚    â”œâ”€ Add to admin queue                    â”‚
â”‚    â”œâ”€ Notify admin (future)                â”‚
â”‚    â””â”€ Wait for manual approval             â”‚
â”‚  }                                           â”‚
â”‚                                               â”‚
â”‚  else if status == "reject" {                â”‚
â”‚    â”œâ”€ Update invoice.status = "rejected"   â”‚
â”‚    â”œâ”€ Add rejection reason                 â”‚
â”‚    â”œâ”€ Notify client (future)               â”‚
â”‚    â””â”€ Request clarification                â”‚
â”‚  }                                           â”‚
â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ All updates complete
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SUPABASE POSTGRESQL DATABASE               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  invoices                                    â”‚
â”‚  â”œâ”€ extracted_data (JSONB)  â† Full JSON     â”‚
â”‚  â”œâ”€ confidence_score (0-1)  â† Overall       â”‚
â”‚  â”œâ”€ status (approved/review) â† Routed       â”‚
â”‚  â””â”€ approved_by, approved_at â† Metadata     â”‚
â”‚                                              â”‚
â”‚  extraction_confidence (audit)               â”‚
â”‚  â”œâ”€ invoice_id                              â”‚
â”‚  â”œâ”€ field_name (gstin, amount, etc)        â”‚
â”‚  â”œâ”€ confidence_score (per field)            â”‚
â”‚  â”œâ”€ extracted_value vs validated_value      â”‚
â”‚  â””â”€ is_corrected, correction_source         â”‚
â”‚                                              â”‚
â”‚  activity_log (audit trail)                  â”‚
â”‚  â”œâ”€ user_id, action, entity_type            â”‚
â”‚  â”œâ”€ old_values, new_values (JSONB)          â”‚
â”‚  â””â”€ timestamp for compliance                â”‚
â”‚                                              â”‚
â”‚  gst_summary (auto-updated)                  â”‚
â”‚  â”œâ”€ total_approved +1                       â”‚
â”‚  â””â”€ updated_at = NOW()                      â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow - Step by Step

### Step 1: User Uploads Invoice

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Uploads      â”‚
â”‚   invoice.pdf       â”‚
â”‚   (5MB)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ useFileUpload Hook      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1. Validate type/size   â”‚
    â”‚ 2. Upload to Storage    â”‚
    â”‚ 3. Get file path        â”‚
    â”‚ 4. Create invoice DB    â”‚
    â”‚ 5. Return invoiceId     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Supabase Storage        â”‚
         â”‚  /invoices/2026/01/      â”‚
         â”‚  filename.pdf            â”‚
         â”‚  (Secure signed URL)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ invoices table   â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ id: UUID         â”‚
              â”‚ status: pending  â”‚
              â”‚ file_path: ...   â”‚
              â”‚ file_size: 5MB   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 2: Extract with AI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/ai/extract     â”‚
â”‚ + fileBase64             â”‚
â”‚ + invoiceId              â”‚
â”‚ + userId                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Verify Auth      â”‚
      â”‚ Check ownership  â”‚
      â”‚ Load invoice     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OpenRouter API Call         â”‚
    â”‚ model: gpt-oss-20b          â”‚
    â”‚ input: image + prompt       â”‚
    â”‚ temp: 0.3 (consistent)      â”‚
    â”‚ timeout: 10s                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼ (3-5 seconds)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AI Response (JSON)        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ {                         â”‚
    â”‚   invoice_number: "001",  â”‚
    â”‚   invoice_date: "2026-...",
    â”‚   vendor_gstin: "29AAB...",
    â”‚   total_amount: 50000,    â”‚
    â”‚   gst_amount: 9000,       â”‚
    â”‚   hsn_code: "8471",       â”‚
    â”‚   confidence_per_field: { â”‚
    â”‚     gstin: 0.97,          â”‚
    â”‚     amount: 0.94,         â”‚
    â”‚     gst: 0.91,            â”‚
    â”‚     ...                   â”‚
    â”‚   }                       â”‚
    â”‚ }                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validate Extracted Data  â”‚
    â”‚ â€¢ GSTIN 15 chars?        â”‚
    â”‚ â€¢ Amounts numeric?       â”‚
    â”‚ â€¢ Dates valid format?    â”‚
    â”‚ â€¢ Confidence 0-1?        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Confidence Score â”‚
         â”‚ Calculation      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼ (weighted avg)
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 0.93 overall     â”‚
         â”‚ = 93%            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 3: Auto-Routing Decision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Confidence Score: 0.93        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
    â–¼                   â–¼
  0.93 â‰¥ 0.95?       NO
  â”‚                  â”‚
  NO                 Is 0.93 â‰¥ 0.80?
  â”‚                  â”‚
  â”‚                  YES
  â”‚                  â”‚
  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚          â”‚                â”‚
  â”‚    Is GSTIN            YES
  â”‚    confident?          â”‚
  â”‚    â”‚                   â”‚
  â”‚    NO                  â”‚
  â”‚    â”‚                   â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                              â”‚
    Status: "review"              Status: "review"
    Reason: Medium conf           Reason: Low field conf
    Action: Queue for Pavan       Action: Queue for Pavan
```

### Step 4: Database Updates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update invoices Table           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… extracted_data = JSON        â”‚
â”‚ âœ… confidence_score = 0.93      â”‚
â”‚ âœ… status = "review"            â”‚
â”‚ âœ… review_notes = "AI: 93%"    â”‚
â”‚ âœ… updated_at = NOW()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                     â”‚                  â”‚
             â–¼                     â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ extraction_      â”‚  â”‚ activity_log    â”‚ â”‚ gst_summary      â”‚
    â”‚ confidence       â”‚  â”‚                 â”‚ â”‚                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ invoice_id: ..   â”‚  â”‚ user_id: ...    â”‚ â”‚ total_pending++  â”‚
    â”‚ field: gstin     â”‚  â”‚ action: extract â”‚ â”‚ updated_at: NOW()â”‚
    â”‚ score: 0.97      â”‚  â”‚ entity: invoice â”‚ â”‚                  â”‚
    â”‚ value: 29AABC... â”‚  â”‚ id: ...         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚  â”‚ timestamp: ...  â”‚
    â”‚ field: amount    â”‚  â”‚                 â”‚
    â”‚ score: 0.94      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ value: 50000     â”‚
    â”‚                  â”‚
    â”‚ ... 7 total      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Confidence Scoring Example

### Real Invoice Data

```
Invoice from: ABC Electronics Pvt Ltd
GSTIN: 29AABCU9603R1ZM
Amount: â‚¹50,000
CGST: â‚¹4,500 | SGST: â‚¹4,500
Total GST: â‚¹9,000
HSN Code: 8471
```

### AI Extraction Result

```json
{
  "vendor_gstin": "29AABCU9603R1ZM",
  "confidence_per_field": {
    "vendor_gstin": 0.97,
    "total_amount": 0.94,
    "gst_amount": 0.91,
    "hsn_code": 0.88,
    "vendor_name": 0.92,
    "invoice_number": 0.98,
    "invoice_date": 0.95
  }
}
```

### Weighted Calculation

```
Score = Î£(field_score Ã— weight)

= (0.97 Ã— 0.20)    [GSTIN 20%]
+ (0.94 Ã— 0.30)    [Amount 30%]
+ (0.91 Ã— 0.25)    [GST 25%]
+ (0.88 Ã— 0.15)    [HSN 15%]
+ (0.92 Ã— 0.05)    [Vendor 5%]
+ (0.98 Ã— 0.03)    [Invoice# 3%]
+ (0.95 Ã— 0.02)    [Date 2%]

= 0.194 + 0.282 + 0.228 + 0.132 + 0.046 + 0.029 + 0.019
= 0.9306
```

### Decision Tree

```
0.9306 â‰¥ 0.95?
NO
â”‚
â”œâ”€ 0.9306 â‰¥ 0.80?
â”‚ YES
â”‚ â”‚
â”‚ â””â”€ Check critical fields:
â”‚    â”œâ”€ GSTIN 0.97 â‰¥ 0.80? YES âœ“
â”‚    â”œâ”€ Amount 0.94 â‰¥ 0.80? YES âœ“
â”‚    â”œâ”€ GST 0.91 â‰¥ 0.80? YES âœ“
â”‚    â”‚
â”‚    â””â”€ All critical OK!
â”‚
â””â”€ STATUS: "review"
   REASON: "93% confidence - requires admin review"
   ACTION: "Added to Pavan's queue"
```

---

## User Journey Timeline

```
Timeline: Invoice Upload â†’ Auto-Approval

T+0s    User clicks "Upload Invoice"
        File selected (PDF 3MB)

T+1s    Upload starts
        â”œâ”€ File transmitted
        â””â”€ Supabase Storage receives

T+2s    File stored
        â”œâ”€ Path: /invoices/2026/01/INV-001.pdf
        â””â”€ URL generated (signed)

T+3s    Invoice record created
        â”œâ”€ invoices.status = "pending"
        â”œâ”€ invoices.file_path = (path)
        â””â”€ invoiceId generated

T+3-4s  User sees "Invoice uploaded"
        Message: "Processing..."

T+4-8s  AI extraction running
        â”œâ”€ Image sent to OpenRouter
        â”œâ”€ gpt-oss-20b analyzing
        â””â”€ Data extraction in progress

T+8-9s  Extraction complete
        â”œâ”€ JSON received from AI
        â”œâ”€ Field scores calculated
        â””â”€ Confidence weighted

T+9-10s Database updates
        â”œâ”€ extracted_data stored
        â”œâ”€ confidence_score saved
        â”œâ”€ activity logged
        â””â”€ GST summary updated

T+10s   âœ… COMPLETE
        User sees result:
        â”œâ”€ Extracted data displayed
        â”œâ”€ Confidence: 93%
        â”œâ”€ Status: "Awaiting Review"
        â””â”€ Pavan gets notification

If confidence â‰¥ 0.95:
T+10s   âœ… AUTO-APPROVED
        â”œâ”€ Status: "Approved"
        â”œâ”€ Immediate confirmation
        â””â”€ No admin action needed

Timeline: Total = 10 seconds (end-to-end)
```

---

## Admin Approval Workflow

```
Pavan's Daily Workflow

Morning:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/admin/attention-queue  â”‚
â”‚ (Shows all pending items)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Attention Queue      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ 12 invoices pending: â”‚
      â”‚                      â”‚
      â”‚ 8 Ã— Review Queue     â”‚
      â”‚ â”œâ”€ 85% conf         â”‚
      â”‚ â”œâ”€ 87% conf         â”‚
      â”‚ â””â”€ ...              â”‚
      â”‚                      â”‚
      â”‚ 3 Ã— Low Confidence   â”‚
      â”‚ â”œâ”€ 75% conf         â”‚
      â”‚ â””â”€ ...              â”‚
      â”‚                      â”‚
      â”‚ 1 Ã— Pending Extract  â”‚
      â”‚ â””â”€ Not yet analyzed  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Pavan Opens Item #1      â”‚
     â”‚ â€¢ Confidence: 87%        â”‚
     â”‚ â€¢ Vendor: ABC Corp       â”‚
     â”‚ â€¢ Amount: â‚¹50,000        â”‚
     â”‚ â€¢ View extracted data    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   [Review]  â”‚    â”‚   [Reject]   â”‚
   â”‚   Data OK?  â”‚    â”‚ Issues found?â”‚
   â”‚     âœ“       â”‚    â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚              â”‚
         â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â–¼                   â–¼
   POST /approve         POST /reject
   â”œâ”€ notes: "OK"        â”œâ”€ reason: "..."
   â””â”€ update: approved   â””â”€ update: rejected
                              notify: client


Response for Approved:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Approved          â”‚
â”‚ By: Pavan            â”‚
â”‚ Time: T+12s          â”‚
â”‚ Status: Approved     â”‚
â”‚ Activity: Logged     â”‚
â”‚ Client: Notified     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Flow Complete!** ğŸ‰  
Your system is now extraction-ready.
